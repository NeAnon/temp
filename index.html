<!DOCTYPE html>
<html>
<head>
  <script type = "text/javascript">
    var fields;

    function openDefaultTab(){
     // Get the element with id="defaultOpen" and click on it  
      document.getElementById('defaultOpen').click();
      fields = 1;
    }

    function openTab(evt, TabName) {
      // Declare all variables
      var i, tabcontent, tabs;

      // Get all elements with class="tabcontent" and hide them
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      // Get all elements with class="tabs" and remove the class "active"
      tabs = document.getElementsByClassName("tabs");
      for (i = 0; i < tabs.length; i++) {
        tabs[i].className = tabs[i].className.replace("active", "");
      }
    

    // Show the current tab, and add an "active" class to the button that opened the tab
      document.getElementById(TabName).style.display = "block";
      evt.currentTarget.className += "active";
    }

    //I don't know if I should trust this function. I might switch over to FileSaver.js in case of compat issues.

    function download(filename, content) {
      var element = document.createElement('a');                                                      //Create a new element (a hyperlink to a file)
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));   //The file contents are of a plaintext type
      element.setAttribute('download', filename);                                                     //And set to be downloaded upon submitting the form
      element.setAttribute('target', '_blank');    element.setAttribute('rel', "noopener noreferrer");    

      //This element is temporarily placed in the browser body, activated, and then removed.
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    } 

    function addField(){
      //alert("Started...");
      var varList = document.getElementById("varList");
      var count = parseInt(varList.getAttribute('count'));
      //alert(count);
      //alert("value saved! Current count: " + varList.getAttribute('value'));
      newDiv = document.createElement('div');
      newDiv.id = 'var'+count+'container';

      element = document.createElement('input');
      element.type = "text";
      element.id= 'var'+(count);
      element.size=10;
      //alert("child created.");
      newDiv.appendChild(element);

      //alert("Child textbox added, id: " +(element.getAttribute('id')));
      
      linebreak = document.createElement("br");
      newDiv.appendChild(linebreak);
      newDiv.setAttribute('posX', 0);
      alert("Pos X: "+newDiv.getAttribute('posX'));
      newDiv.setAttribute('posY', 0);
      varList.append(newDiv);
      alert("adding image...");
      addImage(newDiv.id);
      //alert(newDiv.posX);

      varList.setAttribute('count', count+1);
      /*
      alert(ref.id);
      if(parseInt(varList.getAttribute('count')) > 2){
        alert("More than 2 textboxes.");
        alert("Textbox 3 contents: " + document.getElementById("var2").value);
      }
      */
    }

    function removeField(){
      var varList = document.getElementById("varList");
      //alert("varList located");
      if(parseInt(varList.getAttribute('count')) <= 0){
        alert("no textboxes to delete.")
        return;
      }
      varList.setAttribute('count', parseInt(varList.getAttribute('count'))-1)
      var targetId = 'var'+(parseInt(varList.getAttribute('count')))+'container';
      //alert("target's Id: " + targetId);
      document.getElementById(targetId).remove();
      //alert("Target deleted.");
    }
    
    function findAndReplaceAll(templateText){
      var varCount = parseInt(document.getElementById("varList").getAttribute('count'));
      //alert(varCount);
      for(var i = 0; i < varCount; i++){
        //alert("replacing %"+i+"% with var"+i);
        //alert("textbox value: " + document.getElementById('var'+i).value);
        templateText = templateText.replaceAll('%'+i+'%', document.getElementById('var'+i).value);
        //alert("Success!");
      }
      //alert(templateText);
      return templateText;
    }    

    function addImage(sourceDivId){
      //Nooooo you can't just pass this shit directly, you have to do this funny
      //fucking roundabout shit to read any values you set on a div
      var sourceDiv = document.getElementById(sourceDivId);
      newImage = document.createElement('div');
      //newImage.setAttribute('referenceId', sourceDiv.id);
      //newImage.setAttribute('id', sourceDiv.id + 'Image');
      //IM LOSING MY FUCKInG MIND WITH THIS LANGUAGE WHY DOES EVERYTHING FAIL SILENTLY
      newImage.setAttribute('posX', sourceDiv.getAttribute('posX'));
      newImage.setAttribute('posY', sourceDiv.getAttribute('posY'));
      newImage.setAttribute('referenceId', sourceDiv.getAttribute('id'));
      newImage.setAttribute('id', 'var0containerImage');
      
      newImage.appendChild(sourceDiv.firstChild.cloneNode(false));
      newImage.firstChild.setAttribute('id', sourceDiv.firstChild.id+'Image');

      alert("Type: "+newImage.firstChild.nodeName + " Id: " + newImage.firstChild.id);
      document.getElementById('varImage').appendChild(newImage);
//      alert(newImage.id);
    }

    function callAllImages(){
      alert('calling all images!');
      alert('To call: ' + document.getElementById('varList').getAttribute('count'));
      for (let index = 0; index < document.getElementById('varList').getAttribute('count'); index++) {
        //var workingElement = document.getElementById(('var'+index+'containerImage').toString);
        var workingElement = document.getElementById('var0containerImage');
        alert('calling ' + 'var'+index+'containerImage. type: ' + workingElement.type);
        alert("element " + workingElement.getAttribute('id') + " exists." );
        alert("\nposition X: " + workingElement.getAttribute('posX')+
              "\nposition Y: " + workingElement.getAttribute('posY')+ 
              "\nreferenced element: " + workingElement.getAttribute('referenceId'));
      }
    }
  </script>
    
</head>
<body onload="openDefaultTab()">

  <!-- Tab links -->
  <div class="tab">
    <button class="tabs" onclick="openTab(event, 'Fill')" >Fill</button>
    <button class="tabs" onclick="openTab(event, 'Design')" id="defaultOpen">Design</button>
    <button class="tabs" onclick="openTab(event, 'Code')">Code</button>
  </div>

  <!-- Tab content -->
  <div id="Fill" class="tabcontent">
    <h3>Fill</h3>
    <div id = "varList" count = '0'>
    </div>
    <button onclick="download(findAndReplaceAll(getElementById('filenameInput').value), findAndReplaceAll(getElementById('templateText').value));">Download</button> <br/>
    <!-- <button onclick="findAndReplaceAll(getElementById('templateText').value);">Parse test</button> <br/> -->
  </div>

  <div id="Design" class="tabcontent">
    <h3>Design</h3>
    <button onclick="addField();">Add field</button>
    <button onclick="removeField();">Remove field</button>
    <button onclick="callAllImages();">Call all var images</button>
    <div id = "varImage" class = "images">
    </div>
  </div>

  <div id="Code" class="tabcontent">
    <h3>Code</h3>
    <div class="codeEntry">
      <textarea name="template" id="templateText"></textarea>
    </div>
    <input id="filenameInput" type="text" name="name" placeholder="filename.extension"> <br>
  </div> 

</body>
</html>